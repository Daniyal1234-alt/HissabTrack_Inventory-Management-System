CREATE DATABASE IF NOT EXISTS HissabTrack;

-- ADMIN TABLE
CREATE TABLE IF NOT EXISTS Admin (
    adminID INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255),
    CNIC VARCHAR(255) UNIQUE,
    address VARCHAR(255),
    active BOOLEAN
);
ALTER TABLE Admin
ADD COLUMN password VARCHAR(255) NOT NULL;
-- INVENTORY MANAGER TABLE
CREATE TABLE IF NOT EXISTS InventoryManager (
    managerID INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255),
    CNIC VARCHAR(255) UNIQUE,
    address VARCHAR(255),
    storeID INT UNIQUE
);
SELECT * FROM InventoryManager a JOIN admininventorymanager b WHERE a.managerID = b.inventoryManagerID
-- STORE TABLE
CREATE TABLE IF NOT EXISTS Store (
    storeID INT AUTO_INCREMENT PRIMARY KEY,
    location VARCHAR(255)
);

-- SUPPLIER TABLE
CREATE TABLE IF NOT EXISTS Supplier (
    supplierID INT AUTO_INCREMENT PRIMARY KEY,
    companyName VARCHAR(255),
    location VARCHAR(255),
    registrationNum INT UNIQUE
);

-- INVOICE TABLE
CREATE TABLE IF NOT EXISTS Invoice (
    invoiceID INT AUTO_INCREMENT PRIMARY KEY,
    createdByID INT,
    createdOn DATE,
    userType VARCHAR(255),
    paid BOOLEAN, 
    deliverd BOOLEAN
);
-- REPORT TABLE
CREATE TABLE IF NOT EXISTS Report (
    reportID INT AUTO_INCREMENT PRIMARY KEY,
    createdByID INT,
    createdOn DATE,
    userType VARCHAR(255)
);

-- PRODUCT TABLE 
CREATE TABLE IF NOT EXISTS Product (
    productID INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255),
    description VARCHAR(255),
    supplierID INT,
    price DOUBLE,
    MFG DATE,
    EXP DATE
);

-- STOCK TABLE
CREATE TABLE IF NOT EXISTS Stock (
    stockID INT AUTO_INCREMENT PRIMARY KEY,
    productID INT,
    storeID INT, 
    quantity INT,
    totalCost DOUBLE,
    arrivalDate DATE
);

-- PRODUCT CATALOG TABLE
CREATE TABLE IF NOT EXISTS ProductCatalog (
    productCatalogID INT AUTO_INCREMENT PRIMARY KEY,
    supplierID INT
);

-- ADMIN-INVENTORY MANAGER RELATION TABLE
CREATE TABLE IF NOT EXISTS AdminInventoryManager (
    adminID INT,
    inventoryManagerID INT
);

-- ADMIN-UNPAID INVOICES TABLE
CREATE TABLE IF NOT EXISTS AdminUnpaidInvoices (
    adminID INT,
    invoiceID INT
);

-- STORE-STOCK RELATION TABLE
CREATE TABLE IF NOT EXISTS StoreStock (
    storeID INT,
    stockID INT
);

-- PRODUCT CATALOG-PRODUCTS TABLE
CREATE TABLE IF NOT EXISTS ProductCatalogProducts (
    catalogID INT,
    productID INT
);
ALTER TABLE ProductCatalogProducts
ADD COLUMN quantity INT NOT NULL DEFAULT 0;

-- SUPPLIER-CATALOG RELATION TABLE
CREATE TABLE IF NOT EXISTS SupplierCatalog (
    supplierID INT,
    catalogID INT
);

-- SUPPLIER-PENDING ORDERS TABLE
CREATE TABLE IF NOT EXISTS SupplierPendingOrders (
    supplierID INT,
    invoiceID INT
);
-- SUPPLIER-ADMIN TABLE
CREATE TABLE IF NOT EXISTS SupplierAdmin (
    supplierID INT,
    adminID INT
);
SELECT* FROM Supplier s JOIN SupplierCatalog sc ON s.supplierID = sc.supplierID JOIN productcatalogproducts cp ON sc.catalogID = cp.catalogID JOIN product ps ON cp.productID = ps.productID 
SELECT s.supplierID, s.comapanyName, s.location, s.registerationNum, 
		                       sc.catalogID, cp.productID, p.name AS productName, p.description, 
		                       p.price, p.MFG, p.EXP 
		                FROM Supplier s 
		                JOIN SupplierCatalog sc ON s.supplierID = sc.supplierID 
		                JOIN ProductCatalogProducts cp ON sc.catalogID = cp.catalogID 
		                JOIN Product p ON cp.productID = p.productID
SHOW TABLES
DESCRIBE supplier;
-- Add password field to InventoryManager
ALTER TABLE InventoryManager
ADD COLUMN password VARCHAR(255) NOT NULL;

-- Add password field to Supplier
ALTER TABLE Supplier
ADD COLUMN password VARCHAR(255) NOT NULL;
  SELECT i.invoiceID, i.createdByID, i.createdOn, i.userType, i.delivered, i.paid
        FROM Invoice i 
        JOIN SupplierPendingOrders spo ON i.invoiceID = spo.invoiceID 
        WHERE spo.supplierID = 1
SELECT * FROM Invoice i JOIN adminunpaidinvoices AI ON i.invoiceID = AI.invoiceID WHERE paid = FALSE
-- ALTER TABLE TO ADD FOREIGN KEYS
ALTER TABLE InventoryManager
ADD FOREIGN KEY (storeID) REFERENCES Store(storeID) ON DELETE SET NULL;

ALTER TABLE Product
ADD FOREIGN KEY (supplierID) REFERENCES Supplier(supplierID) ON DELETE CASCADE;

ALTER TABLE Stock
ADD FOREIGN KEY (productID) REFERENCES Product(productID) ON DELETE CASCADE,
ADD FOREIGN KEY (storeID) REFERENCES Store(storeID) ON DELETE CASCADE;

ALTER TABLE ProductCatalog
ADD FOREIGN KEY (supplierID) REFERENCES Supplier(supplierID) ON DELETE CASCADE;

ALTER TABLE AdminInventoryManager
ADD FOREIGN KEY (adminID) REFERENCES Admin(adminID) ON DELETE CASCADE,
ADD FOREIGN KEY (inventoryManagerID) REFERENCES InventoryManager(managerID) ON DELETE CASCADE;

ALTER TABLE AdminUnpaidInvoices
ADD FOREIGN KEY (adminID) REFERENCES Admin(adminID) ON DELETE CASCADE,
ADD FOREIGN KEY (invoiceID) REFERENCES Invoice(invoiceID) ON DELETE CASCADE;

ALTER TABLE StoreStock
ADD FOREIGN KEY (storeID) REFERENCES Store(storeID) ON DELETE CASCADE,
ADD FOREIGN KEY (stockID) REFERENCES Stock(stockID) ON DELETE CASCADE;

ALTER TABLE ProductCatalogProducts
ADD FOREIGN KEY (catalogID) REFERENCES ProductCatalog(productCatalogID) ON DELETE CASCADE,
ADD FOREIGN KEY (productID) REFERENCES Product(productID) ON DELETE CASCADE;

ALTER TABLE SupplierCatalog
ADD FOREIGN KEY (supplierID) REFERENCES Supplier(supplierID) ON DELETE CASCADE,
ADD FOREIGN KEY (catalogID) REFERENCES ProductCatalog(productCatalogID) ON DELETE CASCADE;

ALTER TABLE SupplierPendingOrders
ADD FOREIGN KEY (supplierID) REFERENCES Supplier(supplierID) ON DELETE CASCADE,
ADD FOREIGN KEY (invoiceID) REFERENCES Invoice(invoiceID) ON DELETE CASCADE;